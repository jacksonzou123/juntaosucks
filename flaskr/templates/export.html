{% extends 'base.html' %}

{% block style %}
{{ super() }}
{% endblock %}

{% block content %}
<!--Add buttons to initiate auth sequence and sign out-->
<button id='authorize_button' style='display: none;'>Authorize</button>
<button id='signout_button' style='display: none;'>Sign Out</button>

<pre id='content' style='white-space: pre-wrap;'></pre>

<script type='text/javascript'>
  // Transactions from Flask
  const transactions = JSON.parse('{{ transactions|tojson|safe }}');

  // Sheets Setting
  const range = `Sheet1!A1:${String.fromCharCode(Object.keys(transactions[0]).length + 65)}${Object.keys(transactions).length + 1}`;
  const cell = [Object.keys(transactions[0])];
  Object.keys(transactions).map(key => cell.push(Object.values(transactions[key])));
  const body = {
    'range': range,
    "majorDimension": "ROWS",
    'values': cell
  };

  // Create Sheets Response
  let sheetsResponse;

  // Client ID and API key from the Developer Console
  const CLIENT_ID = '{{ sheets_client_id }}';
  const API_KEY = '{{ sheets_api_key }}';

  // Array of API discovery doc URLs for APIs used by the quickstart
  const DISCOVERY_DOCS = ['https://sheets.googleapis.com/$discovery/rest?version=v4'];

  // Authorization scopes required by the API; multiple scopes can be
  // included, separated by spaces.
  const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

  const authorizeButton = document.getElementById('authorize_button');
  const signoutButton = document.getElementById('signout_button');

  const handleClientLoad = _ => {
    gapi.load('client:auth2', initClient);
  }

  const initClient = _ => {
    gapi.client.init({
      apiKey: API_KEY,
      clientId: CLIENT_ID,
      discoveryDocs: DISCOVERY_DOCS,
      scope: SCOPES
    }).then(function () {
      // Listen for sign-in state changes.
      gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
      // Handle the initial sign-in state.
      updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
      authorizeButton.onclick = handleAuthClick;
      signoutButton.onclick = handleSignoutClick;
    }, function (error) {
      appendPre(JSON.stringify(error, null, 2));
    }).catch(res => console.log(res));
  }

  /**
   *  Called when the signed in status changes, to update the UI
   *  appropriately. After a sign-in, the API is called.
   */
  const updateSigninStatus = isSignedIn => {
    if (isSignedIn) {
      authorizeButton.style.display = 'none';
      signoutButton.style.display = 'block';
      exportToSheets();
    } else {
      authorizeButton.style.display = 'block';
      signoutButton.style.display = 'none';
    }
  }

  /**
   *  Sign in the user upon button click.
   */
  const handleAuthClick = event => {
    gapi.auth2.getAuthInstance().signIn();
  }

  /**
   *  Sign out the user upon button click.
   */
  const handleSignoutClick = event => {
    gapi.auth2.getAuthInstance().signOut();
  }

  /**
   * Append a pre element to the body containing the given message
   * as its text node. Used to display the results of the API call.
   *
   * @param {string} message Text to be placed in pre element.
   */
  function appendPre(message) {
    const pre = document.getElementById('content');
    const textContent = document.createTextNode(message + '\n');
    pre.appendChild(textContent);
  }

  /**
   * Print the names and majors of students in a sample spreadsheet:
   * https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms/edit
   */
  function exportToSheets() {
    gapi.client.sheets.spreadsheets.create({ properties: { title: `${new Date()}---Transaction` } })
      .then(response => sheetsResponse = response)
      .then(_ => gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: ha.result.spreadsheetId,
        range: range,
        valueInputOption: 'RAW'
      }, body))
      .catch(res => console.log(res));
  }

</script>

<script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()"
  onreadystatechange="if (this.readyState === 'complete') this.onload()">
  </script>
{% endblock %}

{% block footer %}
<footer class='mt-auto p-3'>
  <div class='container d-flex justify-content-end p-0 m-0'>
    <span class='text-muted'>&copy; Copyright 2019 JaJeJu</span>
  </div>
</footer>
{% endblock %}

{% block scripts %}
{{ super() }}
{% endblock %}